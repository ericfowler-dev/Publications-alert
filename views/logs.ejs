<%- include('partials/head', { title: 'Distribution Logs' }) %>
<%- include('partials/nav', { currentPage: 'logs' }) %>

<% if (success) { %>
<div class="toast toast-success" id="toast"><%= success %></div>
<% } %>
<% if (error) { %>
<div class="toast toast-error" id="toast"><%= error %></div>
<% } %>

<div class="page-header">
    <div>
        <h1>Distribution Logs</h1>
        <div class="subtitle">Audit trail of all publication notifications &mdash; <%= logs.length %> record(s) in <%= groups.length %> event(s)</div>
    </div>
    <div class="page-actions">
        <a href="/logs/export?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %><%= urgencyFilter ? 'urgency=' + encodeURIComponent(urgencyFilter) : '' %>" class="btn btn-secondary btn-sm" title="Export to Excel">&#128196; Export .xlsx</a>
    </div>
</div>

<!-- Toolbar -->
<div class="table-toolbar">
    <form method="GET" action="/logs" class="toolbar-search">
        <input type="text" name="search" placeholder="Search by publication, recipient, company, or email..." value="<%= search %>" class="search-input">
        <button type="submit" class="btn btn-primary btn-sm">Search</button>
        <% if (search || urgencyFilter) { %>
            <a href="/logs" class="btn btn-secondary btn-sm">Clear</a>
        <% } %>
    </form>
    <div class="filter-group">
        <span class="filter-label">Urgency:</span>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Critical/Safety" class="filter-pill <%= urgencyFilter === 'Critical/Safety' ? 'active' : '' %>">Critical</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=High" class="filter-pill <%= urgencyFilter === 'High' ? 'active' : '' %>">High</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Standard" class="filter-pill <%= urgencyFilter === 'Standard' ? 'active' : '' %>">Standard</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Informational" class="filter-pill <%= urgencyFilter === 'Informational' ? 'active' : '' %>">Info</a>
    </div>
    <div class="refresh-controls">
        <button type="button" class="btn btn-secondary btn-sm" onclick="location.reload();" title="Refresh now">&#8635; Refresh</button>
        <label class="auto-refresh-toggle">
            <input type="checkbox" id="autoRefreshToggle"> Auto (30s)
        </label>
    </div>
</div>

<% if (groups.length > 0) { %>
<!-- Bulk actions bar -->
<div id="bulkBar" class="bulk-actions-bar" style="display:none;">
    <span id="selectedCount">0</span> selected &mdash;
    <button type="button" class="btn btn-primary btn-sm" onclick="bulkResend()">&#8635; Resend Selected</button>
    <button type="button" class="btn btn-sm" onclick="bulkDelete()" style="background: var(--danger); color: #fff;">&#10005; Delete Selected</button>
    <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear Selection</button>
</div>

<% groups.forEach(function(group, gi) { %>
<div class="card log-group-card" style="margin-bottom: 12px;">
    <!-- Group Header (clickable) -->
    <div class="log-group-header" onclick="toggleGroup('<%= gi %>')" style="cursor: pointer;">
        <div class="log-group-left">
            <input type="checkbox" class="group-checkbox" data-group="<%= gi %>" onclick="event.stopPropagation(); toggleGroupCheckboxes(<%= gi %>);" title="Select all in this event">
            <span class="log-group-toggle" id="toggle-<%= gi %>">&#9654;</span>
            <span class="badge badge-<%= group.urgency === 'Critical/Safety' ? 'critical' : group.urgency === 'High' ? 'high' : group.urgency === 'Standard' ? 'standard' : 'informational' %>"><%= group.urgency %></span>
            <strong><%= group.publication_number %></strong>
            <span class="text-muted">&mdash; <%= group.publication_title %></span>
        </div>
        <div class="log-group-right">
            <span class="text-muted" style="font-size: 12px;"><%= group.content_type %></span>
            <span class="log-group-count"><%= group.entries.length %> recipient<%= group.entries.length !== 1 ? 's' : '' %></span>
            <span class="text-muted" style="font-size: 12px; white-space: nowrap;"><%= new Date(group.sent_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %> <%= new Date(group.sent_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
        </div>
    </div>
    <!-- Group Detail (collapsed by default) -->
    <div class="log-group-body" id="group-<%= gi %>" style="display: none;">
        <table class="log-group-table">
            <thead>
                <tr>
                    <th style="width:36px;"></th>
                    <th>Recipient</th>
                    <th>Company</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th style="width:70px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <% group.entries.forEach(function(log) { %>
                <tr>
                    <td><input type="checkbox" class="log-checkbox" value="<%= log.id %>" data-group="<%= gi %>"></td>
                    <td><%= log.recipient_name %></td>
                    <td><%= log.recipient_company %></td>
                    <td><%= log.recipient_email %></td>
                    <td><span class="badge badge-<%= log.delivery_status.toLowerCase() %>"><%= log.delivery_status %></span></td>
                    <td class="actions">
                        <form action="/logs/<%= log.id %>/resend" method="POST" style="display:inline;" onsubmit="return confirm('Resend this notification to <%= log.recipient_name %>?')">
                            <button type="submit" class="btn btn-secondary btn-sm" title="Resend">&#8635;</button>
                        </form>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>
<% }); %>

<% } else { %>
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="empty-state-icon">&#9776;</div>
            <h3>No distribution logs found</h3>
            <% if (search || urgencyFilter) { %>
                <p>No logs match your search criteria.</p>
                <a href="/logs" class="btn btn-secondary">Clear Filters</a>
            <% } else { %>
                <p>Logs will appear here after publications are distributed to customers.</p>
                <a href="/publications" class="btn btn-primary">View Publications</a>
            <% } %>
        </div>
    </div>
</div>
<% } %>

<script>
// Toast auto-dismiss
var toast = document.getElementById('toast');
if (toast) { setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 300); }, 5000); }

// Auto-refresh
var autoRefreshInterval = null;
var autoRefreshToggle = document.getElementById('autoRefreshToggle');
if (localStorage.getItem('logsAutoRefresh') === 'true') {
    autoRefreshToggle.checked = true;
    startAutoRefresh();
}
autoRefreshToggle.addEventListener('change', function() {
    if (this.checked) { localStorage.setItem('logsAutoRefresh', 'true'); startAutoRefresh(); }
    else { localStorage.setItem('logsAutoRefresh', 'false'); stopAutoRefresh(); }
});
function startAutoRefresh() { stopAutoRefresh(); autoRefreshInterval = setInterval(function() { location.reload(); }, 30000); }
function stopAutoRefresh() { if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; } }

// Toggle group expand/collapse
function toggleGroup(gi) {
    var body = document.getElementById('group-' + gi);
    var toggle = document.getElementById('toggle-' + gi);
    if (body.style.display === 'none') {
        body.style.display = 'block';
        toggle.innerHTML = '&#9660;';
    } else {
        body.style.display = 'none';
        toggle.innerHTML = '&#9654;';
    }
}

// Checkbox logic
var bulkBar = document.getElementById('bulkBar');
var selectedCountEl = document.getElementById('selectedCount');

function updateBulkBar() {
    var checked = document.querySelectorAll('.log-checkbox:checked');
    if (checked.length > 0) {
        bulkBar.style.display = 'flex';
        selectedCountEl.textContent = checked.length;
    } else {
        bulkBar.style.display = 'none';
    }
    // Update group checkboxes
    document.querySelectorAll('.group-checkbox').forEach(function(gcb) {
        var gi = gcb.dataset.group;
        var groupCBs = document.querySelectorAll('.log-checkbox[data-group="' + gi + '"]');
        var allChecked = groupCBs.length > 0 && Array.from(groupCBs).every(function(cb) { return cb.checked; });
        gcb.checked = allChecked;
    });
}

function toggleGroupCheckboxes(gi) {
    var gcb = document.querySelector('.group-checkbox[data-group="' + gi + '"]');
    var groupCBs = document.querySelectorAll('.log-checkbox[data-group="' + gi + '"]');
    groupCBs.forEach(function(cb) { cb.checked = gcb.checked; });
    // Auto-expand when selecting
    if (gcb.checked) {
        var body = document.getElementById('group-' + gi);
        var toggle = document.getElementById('toggle-' + gi);
        body.style.display = 'block';
        toggle.innerHTML = '&#9660;';
    }
    updateBulkBar();
}

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('log-checkbox')) { updateBulkBar(); }
});

function clearSelection() {
    document.querySelectorAll('.log-checkbox').forEach(function(cb) { cb.checked = false; });
    document.querySelectorAll('.group-checkbox').forEach(function(cb) { cb.checked = false; });
    updateBulkBar();
}

function getSelectedIds() {
    var ids = [];
    document.querySelectorAll('.log-checkbox:checked').forEach(function(cb) { ids.push(parseInt(cb.value)); });
    return ids;
}

function bulkResend() {
    var ids = getSelectedIds();
    if (ids.length === 0) return;
    if (!confirm('Resend ' + ids.length + ' notification(s)?')) return;
    fetch('/logs/resend-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    }).then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.success) {
            location.href = '/logs?success=' + encodeURIComponent('Resent ' + data.count + ' notification(s) successfully');
        } else {
            location.href = '/logs?error=' + encodeURIComponent(data.error || 'Bulk resend failed');
        }
    });
}

function bulkDelete() {
    var ids = getSelectedIds();
    if (ids.length === 0) return;
    if (!confirm('Permanently delete ' + ids.length + ' log record(s)? This cannot be undone.')) return;
    fetch('/logs/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    }).then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.success) {
            location.href = '/logs?success=' + encodeURIComponent('Deleted ' + data.count + ' log record(s)');
        } else {
            location.href = '/logs?error=' + encodeURIComponent(data.error || 'Delete failed');
        }
    });
}
</script>

</main>
</div>
</body>
</html>
