<%- include('partials/head', { title: 'Distribution Logs' }) %>
<%- include('partials/nav', { currentPage: 'logs' }) %>

<% if (success) { %>
<div class="toast toast-success" id="toast"><%= success %></div>
<% } %>
<% if (error) { %>
<div class="toast toast-error" id="toast"><%= error %></div>
<% } %>

<div class="page-header">
    <div>
        <h1>Distribution Logs</h1>
        <div class="subtitle">Audit trail of all publication notifications &mdash; <%= logs.length %> record(s)</div>
    </div>
</div>

<!-- Toolbar -->
<div class="table-toolbar">
    <form method="GET" action="/logs" class="toolbar-search">
        <input type="text" name="search" placeholder="Search by publication, recipient, company, or email..." value="<%= search %>" class="search-input">
        <button type="submit" class="btn btn-primary btn-sm">Search</button>
        <% if (search || urgencyFilter) { %>
            <a href="/logs" class="btn btn-secondary btn-sm">Clear</a>
        <% } %>
    </form>
    <div class="filter-group">
        <span class="filter-label">Urgency:</span>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Critical/Safety" class="filter-pill <%= urgencyFilter === 'Critical/Safety' ? 'active' : '' %>">Critical</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=High" class="filter-pill <%= urgencyFilter === 'High' ? 'active' : '' %>">High</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Standard" class="filter-pill <%= urgencyFilter === 'Standard' ? 'active' : '' %>">Standard</a>
        <a href="/logs?<%= search ? 'search=' + encodeURIComponent(search) + '&' : '' %>urgency=Informational" class="filter-pill <%= urgencyFilter === 'Informational' ? 'active' : '' %>">Info</a>
    </div>
    <div class="refresh-controls">
        <button type="button" class="btn btn-secondary btn-sm" onclick="location.reload();" title="Refresh now">&#8635; Refresh</button>
        <label class="auto-refresh-toggle">
            <input type="checkbox" id="autoRefreshToggle"> Auto (30s)
        </label>
    </div>
</div>

<% if (logs.length > 0) { %>
<!-- Bulk actions bar (hidden until checkboxes selected) -->
<div id="bulkBar" class="bulk-actions-bar" style="display:none;">
    <span id="selectedCount">0</span> selected &mdash;
    <button type="button" class="btn btn-primary btn-sm" onclick="bulkResend()">&#8635; Resend Selected</button>
    <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear Selection</button>
</div>

<div class="card">
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:36px;"><input type="checkbox" id="selectAll" title="Select all"></th>
                        <th>Date</th>
                        <th>Publication</th>
                        <th>Type</th>
                        <th>Urgency</th>
                        <th>Recipient</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% logs.forEach(function(log) { %>
                    <tr>
                        <td><input type="checkbox" class="log-checkbox" value="<%= log.id %>" data-pub="<%= log.publication_number %>"></td>
                        <td style="white-space: nowrap;"><%= new Date(log.sent_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %><br><span class="text-muted"><%= new Date(log.sent_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span></td>
                        <td><strong><%= log.publication_number %></strong><br><span class="text-muted"><%= log.publication_title %></span></td>
                        <td><%= log.content_type %></td>
                        <td>
                            <span class="badge badge-<%= log.urgency === 'Critical/Safety' ? 'critical' : log.urgency === 'High' ? 'high' : log.urgency === 'Standard' ? 'standard' : 'informational' %>">
                                <%= log.urgency %>
                            </span>
                        </td>
                        <td><%= log.recipient_name %></td>
                        <td><%= log.recipient_company %></td>
                        <td><%= log.recipient_email %></td>
                        <td><span class="badge badge-<%= log.delivery_status.toLowerCase() %>"><%= log.delivery_status %></span></td>
                        <td class="actions">
                            <form action="/logs/<%= log.id %>/resend" method="POST" style="display:inline;" onsubmit="return confirm('Resend this notification to <%= log.recipient_name %>?')">
                                <button type="submit" class="btn btn-secondary btn-sm" title="Resend">&#8635;</button>
                            </form>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>
<% } else { %>
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <div class="empty-state-icon">&#9776;</div>
            <h3>No distribution logs found</h3>
            <% if (search || urgencyFilter) { %>
                <p>No logs match your search criteria.</p>
                <a href="/logs" class="btn btn-secondary">Clear Filters</a>
            <% } else { %>
                <p>Logs will appear here after publications are distributed to customers.</p>
                <a href="/publications" class="btn btn-primary">View Publications</a>
            <% } %>
        </div>
    </div>
</div>
<% } %>

<script>
// Toast auto-dismiss
var toast = document.getElementById('toast');
if (toast) { setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 300); }, 5000); }

// Auto-refresh functionality
var autoRefreshInterval = null;
var autoRefreshToggle = document.getElementById('autoRefreshToggle');

if (localStorage.getItem('logsAutoRefresh') === 'true') {
    autoRefreshToggle.checked = true;
    startAutoRefresh();
}

autoRefreshToggle.addEventListener('change', function() {
    if (this.checked) {
        localStorage.setItem('logsAutoRefresh', 'true');
        startAutoRefresh();
    } else {
        localStorage.setItem('logsAutoRefresh', 'false');
        stopAutoRefresh();
    }
});

function startAutoRefresh() {
    stopAutoRefresh();
    autoRefreshInterval = setInterval(function() { location.reload(); }, 30000);
}
function stopAutoRefresh() {
    if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
}

// Checkbox selection & bulk resend
var selectAllCheckbox = document.getElementById('selectAll');
var checkboxes = document.querySelectorAll('.log-checkbox');
var bulkBar = document.getElementById('bulkBar');
var selectedCountEl = document.getElementById('selectedCount');

function updateBulkBar() {
    var checked = document.querySelectorAll('.log-checkbox:checked');
    if (checked.length > 0) {
        bulkBar.style.display = 'flex';
        selectedCountEl.textContent = checked.length;
    } else {
        bulkBar.style.display = 'none';
    }
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = checked.length === checkboxes.length && checkboxes.length > 0;
    }
}

if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
        checkboxes.forEach(function(cb) { cb.checked = selectAllCheckbox.checked; });
        updateBulkBar();
    });
}

checkboxes.forEach(function(cb) {
    cb.addEventListener('change', updateBulkBar);
});

function clearSelection() {
    checkboxes.forEach(function(cb) { cb.checked = false; });
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    updateBulkBar();
}

function bulkResend() {
    var checked = document.querySelectorAll('.log-checkbox:checked');
    var ids = [];
    checked.forEach(function(cb) { ids.push(parseInt(cb.value)); });
    if (ids.length === 0) return;

    if (!confirm('Resend ' + ids.length + ' notification(s)?')) return;

    fetch('/logs/resend-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
    }).then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.success) {
            location.href = '/logs?success=' + encodeURIComponent('Resent ' + data.count + ' notification(s) successfully');
        } else {
            location.href = '/logs?error=' + encodeURIComponent(data.error || 'Bulk resend failed');
        }
    });
}
</script>

</main>
</div>
</body>
</html>
